# 爆速でプロダクトをリリースしようと思ったらマイクロフロントエンドを選んでいた

生成AIの価値をユーザーに早く届けたい。そのために僕たちが選んだのは、「美しさ」よりも「速さ」と「現実解」。結果的に、Angular で作られた既存の基幹システムに、React で作る新規機能を組み込み、チームもシステムも“分離共存”で突き進む構成になりました。この記事では、その意思決定の背景、実装のポイント、実装時の泥臭さ、そしてそこから得た学びをまとめます。

## 背景と制約

- 株式会社カケハシは医療系 SaaS 企業。薬局向け業務システムを提供しています。
- 創業プロダクトの Musubi は、薬剤師の「薬歴」をシステム化し、市場シェアを獲得してきました。
- 近年は後発の競合が台頭し、特に AI 機能の面で差別化が急務に。
- ただし Musubi は歴史ある基幹システムで、技術的負債やバージョン更新の難しさ、利用者の慣れなどもあり、頻繁なリリースが難しい現実があります。
- 一方で、AI 機能はまずユーザーに届けて検証を高速に回す必要がありました。ここに、スピードと安全性の両立という矛盾が生まれます。


## 判断軸と選択肢

最優先は、実際にユーザーに届けるまでの速度とイテレーション性でした。そのために、次の方針で意思決定を行いました。

- リリース速度と検証の回転を最優先にする
- チームとアーキテクチャを独立させ、PharmacyAI チームが自律的にリリース可能にする
- Musubi から UI を独立させて結合度を下げ、変更容易性とリスクの局所化を図る

社内では「Musubi（Angular）内に実装する」「PharmacyAI チームが Angular を学ぶ」といった案も検討しました。しかし、実験速度とチーム独立性の観点から「分離共存」の構成を選択。結果的に、組織の独立性がシステム設計にも表れた、コンウェイの法則的な帰結になりました。


## 選択したアーキテクチャと UI 戦略

### iframe ではなく、JS/CSS を読み込む

採用したのは、Musubi が PharmacyAI（新規 React アプリ）の JavaScript と CSS を読み込み、同一ページ上で協調動作させる構成です。iframe は採用しませんでした。理由は次のとおりです。

- ユーザー視点で 1 つのアプリとしてシームレスに見せたい
- 認証は Musubi 側に委譲し、複雑さを増やさない
- iframe 間通信のレイテンシやデバッグの複雑さを避けたい

### UI 設計とリリース戦略

- Chat のように Musubi の既存画面と競合しにくい、独立した UI を配置
- 依存箇所を最小化して結合度を下げ、実験的機能の追加・変更を容易に
- 事故範囲を限定できる構造にして、段階的ロールアウトを可能に

### CustomEvent による柔らかな連携

親（Musubi, Angular）と子（PharmacyAI, React）の間で、DOM の `CustomEvent` を使って双方向連携しました。

- Musubi → PharmacyAI（コンテキスト同期）
  - 患者 ID、薬歴 ID、処方、来局日などを `ContextUpdated` イベントで通知
  - ページ遷移に追随できるよう、debounce / coalesce を入れ、最終状態（last-write-wins）を採用

- PharmacyAI → Musubi（逆方向ナビゲーション）
  - PharmacyAI で候補選択時に `NavigationIntent` を発火
  - Musubi 側で権限・存在チェック後に画面遷移し、`NavigationResult`（Ack/Nack, reason）で応答

- エラーとフォールバック
  - タイムアウトと指数バックオフで最大 3 回再送
  - 失敗時は手動遷移リンクなどのフォールバックを提示

- 観測性
  - 送受信イベントのログを収集し、タイムラインで可視化
  - デバッグのしやすさを最優先に、Chrome 拡張を自作

- チーム間のルール
  - イベント名の命名規則、ペイロード形式、バージョニングと破壊的変更時の周知手順を明文化
  - 認証トークンの期限切れ時の再認証フローや、拒否時のユーザー通知・リカバリも定義


## 開発の現実（大変だったこと）

きれいごとだけでは回りませんでした。実装の泥臭さも含め、現実的に乗り越えています。

- 切り分けの難しさ（Musubi か PharmacyAI か）
  - どちらで不具合が起きているかの特定が難しい
  - CustomEvent の流れを可視化するため、専用の Chrome 拡張を作成
  - Musubi の読み込み URL を差し替えられる仕組みも用意し、ローカル開発の生産性を確保

- 泥臭い実装（3 回までのリトライ）
  - PharmacyAI が生成した薬歴を Musubi に自動挿入する際、画面遷移タイミングに追いつけず
  - タイムアウトと指数バックオフで最大 3 回まで再送する実装に

- UI の複雑性
  - Musubi のグローバル CSS が PharmacyAI に干渉、`z-index` 管理が難しい
  - 影響範囲を最小化するため、スコープやレイヤーの設計・検証を重ねる

- 状態管理の難しさ
  - 両システムの状態（画面/権限/選択）整合が複雑
  - 会話録音の開始/一時停止/保存と画面遷移の整合、失敗時の再同期やユーザー通知・手動遷移の設計が必要


## 成果とインパクト

- 多くの苦労はありつつも、選択した構成によって開発開始から 4 ヶ月でリリース
- 異なる技術スタック（Angular と React）を持つチームが、独立して開発を継続できる体制を確立
- ビジネス上の仮説検証サイクルが高速化し、価値提供までのリードタイムを短縮


## 学びと示唆

- 目的（ビジネス価値）から逆算することで、「最適」より「現実解」を選べる
- 境界づけられた連携（CustomEvent）と観測性の確保が、組織横断の開発を前に進める
- UI の独立性と事故範囲の限定は、リリースの心理的安全性を高める
- 「美しさ」は重要だが、速度が価値に直結する局面では優先度を柔軟に入れ替える


## おわりに

このアーキテクチャは「美しい理想形」を目指したものではありません。ビジネスの成長を最大化するための、極めて現実的な選択です。フロントエンドエンジニアとして、技術の選択肢をビジネス要求に結びつける視点を持つこと。そのために、チーム構造・UI・観測性・連携方式を一体で設計すること。これらが、今回の取り組みで得た一番の学びでした。

引き続き、この分離共存のアーキテクチャを磨き込みながら、ユーザーに価値を最速で届けていきます。


