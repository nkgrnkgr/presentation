### カンファレンススライドの構成案：メモ

#### 1. イントロダクション
- **自己紹介**: 発表者名、所属、チーム名、SNSアカウントなど。
- **発表タイトル**: 「爆速でプロダクトをリリースしようと思ったらマイクロフロントエンドを選んでいた」。
- **対象オーディエンス**: フロントエンドエンジニア中級者、アーキテクチャやプロダクト開発の意思決定に興味がある人。
- **今日の持ち帰り**: ビジネスゴールを駆動としたアーキテクチャ選定のリアルな実例、AngularとReactを協調させる具体的な技術的選択肢とコード例、そしてその選択の現実的なメリットとデメリット。

---

#### 2. なぜマイクロフロントエンドを選んだか？（背景と意思決定）
- **株式会社カケハシの事業紹介**: 医療系SaaS企業であり、薬局向け業務システムを提供している。
- **Musubiの歴史**: 薬剤師の「薬歴」を手書きからシステム化した創業プロダクトで、市場シェアを獲得して成功した。
- **現在の課題**: 後発サービスが台頭し、AI機能で競合に遅れを取っていることで、Musubiの地位が低下している。
- **技術的・組織的課題**: MusubiチームはAngularに長けた経験豊富なメンバーが多い一方、PharmacyAIチームはReactに精通した新メンバーが中心。Musubiの既存システムは開発サイクルが緩やかで、この「速度差」が課題となった。
- **組織と設計の整合（結果）**: 意図して適用したわけではないが、結果として独立したMusubiチームとPharmacyAIチームの組織構造がシステム設計にも自然に表れた（いわゆるコンウェイの法則的な帰結）。
- **意思決定の軸**: 「美しいアーキテクチャ」ではなく、**ビジネスとプロダクトの成長を最大化する選択**として、高速なイテレーションと、Reactに長けたチームが独立して開発を続けられる体制を構築するために、このアーキテクチャを選択した。

---

#### 3. 技術的選択と課題の解決策
- **選択したアーキテクチャ**: iframeではなく、PharmacyAIがJavaScriptとCSSを提供し、Musubiがそれをロードする構成にした。
- **なぜ `<iframe>` ではないのか？**:
    - ユーザーから見て、一つのアプリケーションとしてシームレスな体験を提供したかった。
    - 認証機能をMusubi側に委ね、シンプルに保ちたかった。
    - iframe間の通信によるレイテンシやデバッグの複雑さを避けたかった。
- **CustomEvent を活用した連携**:
    - 親（Musubi）と子（PharmacyAI）の間で、CustomEvent を使って双方向に情報をやり取りする仕組みを解説。
    - **具体的な情報の共有**: Musubi側の現在のページ情報（例：患者ID、薬歴ID）やページ遷移を、CustomEvent を通じてPharmacyAI側で検知する方法を説明。
    - **AIコンテキスト同期（Musubi→PharmacyAI）**: 患者ID・処方・来局日などを ContextUpdated イベントで通知。ページ遷移に追従できるよう、debounce/coalesce を行い、最終状態を基準に同期（last-write-wins）。
    - **逆方向ナビゲーション（PharmacyAI→Musubi）**: PharmacyAIで患者や処方候補を選択した場合、NavigationIntent イベントを発火。Musubi側で権限・存在チェックののち画面遷移し、NavigationResult（Ack/Nack, reason）で応答。
    - **エラーとリトライ/フォールバック**: タイムアウトと指数バックオフで最大3回まで再送。失敗時は手動遷移リンクを提示するなどフォールバックを用意。
    - **観測性**: 送受信イベントのログ収集と可視化（既述のChrome拡張でのタイムライン表示）により、レース/取りこぼしを発見しやすくする。
    - **チーム間のルール**: イベント名の命名規則や渡すデータ形式、バージョン更新時の手順、破壊的変更の告知フローを明文化。
    - **認証**: Musubi側の認証トークンの有効期限切れ時の再認証フロー、イベント拒否時のユーザー通知とリカバリ手順にも触れる。

---

#### 4. 選択したアーキテクチャの現実（大変だった点）
- **開発・デバッグ環境**:
    - MusubiとPharmacyAIのどちらで不具合が起きているかの切り分けが難しかった。
    - CustomEvent のやり取りのデバッグが難しく、イベントの流れを可視化するために**専用の Chrome 拡張機能を作成した**エピソードを話す。
- **実装の泥臭い対応**:
    - PharmacyAIが生成した薬歴をMusubi側に自動挿入する際、Musubi側の画面遷移に追いつけず、**3回までリトライする**という泥臭い実装になった。
    - コミュニケーションコストを減らすために、PharmacyAIチームが自らMusubi側のコードを修正し、PRを投げた経験を共有する。
- **UIの複雑性**:
    - MusubiのグローバルなCSSがPharmacyAIに影響を与えたり、`z-index` の管理が複雑になったりした。

---

#### 5. まとめと結論
- **この選択の成果**:
    - 多くの苦労はあったものの、この選択によって**開発から3ヶ月でリリース**できた。
    - 異なる技術スタックを持つチームが独立して開発を継続できる体制が整った。
- **結論**:
    - このアーキテクチャは、「美しい」アーキテクチャを目指したものではなく、**ビジネスの成長を最大化するための現実的な選択**だった。
    - フロントエンドエンジニアは、ビジネスの要求に応えるために、このような選択肢もあるということを理解してほしいというメッセージで締めくくる。